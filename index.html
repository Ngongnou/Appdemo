<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f0f0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>GestCarbu</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --coal: #0f0f0f;
  --dark: #181818;
  --panel: #212121;
  --border: #2e2e2e;
  --accent: #f97316;
  --accent-dim: rgba(249,115,22,0.12);
  --gold: #fbbf24;
  --text: #ebebeb;
  --muted: #777;
  --success: #22c55e;
  --danger: #ef4444;
  --nav-h: 72px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body {
  height: 100%;
  overflow: hidden;
  background: var(--coal);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 16px;
}

.app-shell {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
}

/* TOP BAR */
.topbar {
  flex-shrink: 0;
  background: var(--dark);
  border-bottom: 1px solid var(--border);
  padding: calc(var(--safe-top) + 14px) 20px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 10;
}

.logo { display:flex; align-items:center; gap:10px; }
.logo-icon {
  width:38px; height:38px;
  background:var(--accent);
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
}
.logo h1 {
  font-family:'Syne',sans-serif;
  font-weight:800; font-size:1.35rem;
  letter-spacing:-0.03em; color:#fff;
}
.logo h1 span { color:var(--accent); }
.topbar-date { font-size:0.75rem; color:var(--muted); text-align:right; line-height:1.4; }

/* MAIN */
.main-content {
  flex:1; overflow-y:auto; overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
}
.main-content::-webkit-scrollbar { display:none; }

/* SCREENS */
.screen { display:none; padding:16px 16px calc(var(--nav-h) + 24px + var(--safe-bot)); }
.screen.active { display:block; }

/* STATS */
.stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px; }
.stat-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:14px; padding:14px 10px;
  position:relative; overflow:hidden;
}
.stat-card::after {
  content:''; position:absolute; top:0; left:0; right:0; height:3px;
  background:var(--accent);
}
.stat-lbl { font-size:0.62rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:6px; }
.stat-val { font-family:'Syne',sans-serif; font-size:1.5rem; font-weight:800; color:#fff; line-height:1; }
.stat-val small { font-size:0.68rem; color:var(--muted); font-family:'DM Sans'; font-weight:400; }

/* SECTION TITLE */
.section-title {
  font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; color:#fff;
  margin-bottom:14px; display:flex; align-items:center; justify-content:space-between;
}

/* FORM CARD */
.form-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:18px; padding:20px; margin-bottom:16px;
}
.form-group { margin-bottom:16px; }
.form-group:last-child { margin-bottom:0; }
.form-label {
  display:block; font-size:0.72rem; color:var(--muted);
  text-transform:uppercase; letter-spacing:0.07em;
  font-weight:600; margin-bottom:8px;
}
input[type=text], input[type=number], input[type=date], select, textarea {
  width:100%; background:var(--dark); border:1.5px solid var(--border);
  border-radius:12px; color:var(--text); font-family:'DM Sans',sans-serif;
  font-size:1rem; padding:14px 16px; outline:none;
  transition:border-color 0.2s; -webkit-appearance:none; appearance:none;
}
input:focus, select:focus, textarea:focus { border-color:var(--accent); }
textarea { resize:none; min-height:100px; }
select {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23777' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 16px center; padding-right:40px;
}
select option { background:#1a1a1a; }
input[type=date]::-webkit-calendar-picker-indicator { filter:invert(0.5); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

/* BUTTONS */
.btn {
  display:flex; align-items:center; justify-content:center; gap:8px;
  padding:16px 20px; border-radius:14px; border:none;
  font-family:'DM Sans',sans-serif; font-size:0.95rem; font-weight:600;
  cursor:pointer; transition:opacity 0.15s, transform 0.1s;
  width:100%; min-height:52px; -webkit-tap-highlight-color:transparent;
}
.btn:active { transform:scale(0.97); opacity:0.85; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-secondary { background:var(--panel); color:var(--text); border:1.5px solid var(--border); }
.btn-success { background:rgba(34,197,94,0.12); color:var(--success); border:1.5px solid rgba(34,197,94,0.3); }
.btn-sm { padding:10px 14px; min-height:38px; font-size:0.8rem; border-radius:10px; width:auto; }
.btn-icon { width:52px; padding:0; flex-shrink:0; }
.btn-row { display:flex; gap:10px; margin-top:18px; }
.btn-row .btn { flex:1; }

/* DELIVERY CARDS */
.delivery-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:16px; padding:16px; margin-bottom:10px;
  position:relative; overflow:hidden;
}
.delivery-card::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:4px;
  background:var(--accent); border-radius:4px 0 0 4px;
}
.card-top {
  display:flex; justify-content:space-between; align-items:flex-start;
  margin-bottom:10px; padding-left:10px;
}
.card-zone { font-weight:600; font-size:0.92rem; color:var(--text); }
.card-date { font-size:0.74rem; color:var(--muted); margin-top:3px; }
.card-right { display:flex; align-items:center; gap:8px; }
.card-qty { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:800; color:var(--gold); white-space:nowrap; }
.card-bottom { display:flex; justify-content:space-between; align-items:center; padding-left:10px; gap:10px; }
.card-salle {
  font-size:0.78rem; color:var(--accent); background:var(--accent-dim);
  padding:4px 10px; border-radius:20px; display:inline-block; flex-shrink:0;
}
.card-desc {
  font-size:0.76rem; color:var(--muted); font-style:italic;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; text-align:right;
}
.delete-btn {
  background:rgba(239,68,68,0.08); border:none; color:var(--danger);
  width:34px; height:34px; border-radius:9px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:15px; flex-shrink:0;
}
.delete-btn:active { background:rgba(239,68,68,0.22); }

/* EMPTY */
.empty { text-align:center; padding:40px 20px; color:var(--muted); }
.empty-icon { font-size:2.5rem; margin-bottom:10px; }
.empty p { font-size:0.88rem; }

/* FILTER */
.filter-bar {
  display:flex; gap:10px; margin-bottom:14px;
  overflow-x:auto; padding-bottom:4px; scrollbar-width:none;
}
.filter-bar::-webkit-scrollbar { display:none; }
.filter-bar input, .filter-bar select { font-size:0.88rem; padding:11px 14px; }

/* BILAN */
.bilan-select-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px; }
.summary-box {
  background:var(--panel); border:1px solid var(--border);
  border-radius:16px; padding:18px; margin-bottom:14px;
  display:grid; grid-template-columns:repeat(3,1fr); gap:10px; text-align:center;
}
.s-label { font-size:0.62rem; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; margin-bottom:4px; }
.s-val { font-family:'Syne',sans-serif; font-size:1.3rem; font-weight:800; color:#fff; }
.s-val.orange { color:var(--gold); }

/* BOTTOM NAV */
.bottom-nav {
  flex-shrink:0; background:var(--dark); border-top:1px solid var(--border);
  display:flex; padding-bottom:var(--safe-bot); z-index:20;
}
.nav-btn {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; padding:10px 8px; border:none; background:transparent;
  color:var(--muted); font-family:'DM Sans',sans-serif;
  font-size:0.62rem; font-weight:600; cursor:pointer;
  text-transform:uppercase; letter-spacing:0.04em;
  min-height:var(--nav-h); -webkit-tap-highlight-color:transparent;
}
.nav-btn.active { color:var(--accent); }
.nav-icon-wrap {
  width:48px; height:48px; background:var(--panel);
  border-radius:14px; display:flex; align-items:center; justify-content:center;
  transition:all 0.2s; margin-bottom:2px; font-size:21px;
}
.nav-btn.active .nav-icon-wrap {
  background:var(--accent);
  box-shadow:0 4px 16px rgba(249,115,22,0.35);
}

/* TOAST */
.toast {
  position:fixed;
  bottom:calc(var(--nav-h) + var(--safe-bot) + 14px);
  left:50%; transform:translateX(-50%) translateY(20px);
  background:#1e1e1e; border:1px solid var(--border);
  color:var(--text); padding:12px 22px;
  border-radius:100px; font-size:0.88rem; font-weight:600;
  z-index:999; opacity:0;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  white-space:nowrap; pointer-events:none;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="app-shell">

  <header class="topbar">
    <div class="logo">
      <div class="logo-icon">‚õΩ</div>
      <h1>Gest<span>Carbu</span></h1>
    </div>
    <div class="topbar-date" id="top-date"></div>
  </header>

  <main class="main-content">

    <!-- SAISIE -->
    <div class="screen active" id="screen-saisie">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-lbl">Total</div>
          <div class="stat-val" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">Ce mois</div>
          <div class="stat-val" id="stat-qty">0<small>L</small></div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">Zones</div>
          <div class="stat-val" id="stat-zones">0</div>
        </div>
      </div>

      <div class="section-title">‚úèÔ∏è Nouvelle livraison</div>
      <div class="form-card">
        <div class="form-row">
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">üìÖ Date</label>
            <input type="date" id="f-date">
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">‚ö° Quantit√© (L)</label>
            <input type="number" id="f-quantite" placeholder="500" min="0" step="0.5" inputmode="decimal">
          </div>
        </div>
        <div style="height:16px"></div>
        <div class="form-group">
          <label class="form-label">üìç Zone de livraison</label>
          <input type="text" id="f-zone" placeholder="Ex : Zone Industrielle Nord" autocomplete="off">
        </div>
        <div class="form-group">
          <label class="form-label">üè† Salle / B√¢timent</label>
          <input type="text" id="f-salle" placeholder="Ex : Salle B2 / D√©p√¥t 3" autocomplete="off">
        </div>
        <div class="form-group">
          <label class="form-label">üìù Observations</label>
          <textarea id="f-description" placeholder="Remarques, √©tat du mat√©riel..."></textarea>
        </div>
        <div class="btn-row">
          <button class="btn btn-secondary btn-icon" onclick="resetForm()" title="R√©initialiser">‚Ü∫</button>
          <button class="btn btn-primary" onclick="addLivraison()">‚ûï Enregistrer</button>
        </div>
      </div>

      <div class="section-title">
        üìÖ Aujourd'hui
        <button class="btn btn-success btn-sm" onclick="exportDayPDF()">‚¨áÔ∏è PDF</button>
      </div>
      <div id="today-list">
        <div class="empty"><div class="empty-icon">üì¶</div><p>Aucune livraison aujourd'hui</p></div>
      </div>
    </div>

    <!-- HISTORIQUE -->
    <div class="screen" id="screen-historique">
      <div class="section-title">üìã Historique</div>
      <div class="filter-bar">
        <input type="date" id="filter-date" oninput="renderHistorique()">
        <input type="text" id="filter-zone" placeholder="üîç Zone / salle..." oninput="renderHistorique()">
        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">‚úï</button>
      </div>
      <div id="hist-count" style="font-size:0.78rem;color:var(--muted);margin-bottom:12px;"></div>
      <div id="hist-list">
        <div class="empty"><div class="empty-icon">üóÇÔ∏è</div><p>Aucune livraison enregistr√©e</p></div>
      </div>
    </div>

    <!-- BILAN -->
    <div class="screen" id="screen-bilan">
      <div class="section-title">üìä Bilan mensuel</div>
      <div class="form-card">
        <div class="bilan-select-row">
          <div>
            <label class="form-label">Mois</label>
            <select id="bilan-month">
              <option value="0">Janvier</option><option value="1">F√©vrier</option>
              <option value="2">Mars</option><option value="3">Avril</option>
              <option value="4">Mai</option><option value="5">Juin</option>
              <option value="6">Juillet</option><option value="7">Ao√ªt</option>
              <option value="8">Septembre</option><option value="9">Octobre</option>
              <option value="10">Novembre</option><option value="11">D√©cembre</option>
            </select>
          </div>
          <div>
            <label class="form-label">Ann√©e</label>
            <input type="number" id="bilan-year" value="2025" min="2020" max="2099" inputmode="numeric">
          </div>
        </div>
        <div class="btn-row" style="margin-top:14px;">
          <button class="btn btn-secondary" onclick="renderBilan()">üîç Aper√ßu</button>
          <button class="btn btn-primary" onclick="exportBilanPDF()">‚¨áÔ∏è PDF Bilan</button>
        </div>
      </div>
      <div id="bilan-summary" style="display:none;">
        <div class="summary-box" id="bilan-totaux"></div>
        <div class="section-title" id="bilan-list-title">D√©tail</div>
        <div id="bilan-list"></div>
      </div>
      <div id="bilan-empty" class="empty" style="display:none;">
        <div class="empty-icon">üìä</div><p>Aucune livraison ce mois</p>
      </div>
    </div>

  </main>

  <nav class="bottom-nav">
    <button class="nav-btn active" id="nav-saisie" onclick="switchScreen('saisie')">
      <div class="nav-icon-wrap" id="wrap-saisie">‚úèÔ∏è</div>
      <span>Saisie</span>
    </button>
    <button class="nav-btn" id="nav-historique" onclick="switchScreen('historique')">
      <div class="nav-icon-wrap" id="wrap-historique">üìã</div>
      <span>Historique</span>
    </button>
    <button class="nav-btn" id="nav-bilan" onclick="switchScreen('bilan')">
      <div class="nav-icon-wrap" id="wrap-bilan">üìä</div>
      <span>Bilan</span>
    </button>
  </nav>
</div>

<div class="toast" id="toast"></div>

<script>
const { jsPDF } = window.jspdf;
let livraisons = JSON.parse(localStorage.getItem('livraisons_carbu') || '[]');
const now = new Date();
const todayISO = now.toISOString().split('T')[0];

// Init
document.getElementById('f-date').value = todayISO;
document.getElementById('top-date').innerHTML = now.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short'}).replace(/^./,s=>s.toUpperCase());
document.getElementById('bilan-month').value = now.getMonth();
document.getElementById('bilan-year').value = now.getFullYear();
document.getElementById('wrap-saisie').style.cssText = 'background:var(--accent);box-shadow:0 4px 16px rgba(249,115,22,0.35);';
updateStats(); renderTodayList();

function switchScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.classList.remove('active');
    b.querySelector('.nav-icon-wrap').style.cssText='';
  });
  document.getElementById('screen-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  document.getElementById('wrap-'+name).style.cssText='background:var(--accent);box-shadow:0 4px 16px rgba(249,115,22,0.35);';
  document.querySelector('.main-content').scrollTop=0;
  if(name==='historique') renderHistorique();
  if(name==='bilan'){ document.getElementById('bilan-summary').style.display='none'; document.getElementById('bilan-empty').style.display='none'; }
}

function save() {
  localStorage.setItem('livraisons_carbu', JSON.stringify(livraisons));
  updateStats(); renderTodayList();
}

function updateStats() {
  const m=now.getMonth(), y=now.getFullYear();
  const monthly=livraisons.filter(l=>{const d=new Date(l.date);return d.getMonth()===m&&d.getFullYear()===y;});
  const zones=[...new Set(livraisons.map(l=>l.zone))].filter(Boolean);
  document.getElementById('stat-total').textContent=livraisons.length;
  const qty=monthly.reduce((s,l)=>s+(parseFloat(l.quantite)||0),0);
  document.getElementById('stat-qty').innerHTML=qty>=1000?(qty/1000).toFixed(1)+'<small>kL</small>':qty+'<small>L</small>';
  document.getElementById('stat-zones').textContent=zones.length;
}

function addLivraison() {
  const date=document.getElementById('f-date').value;
  const zone=document.getElementById('f-zone').value.trim();
  const salle=document.getElementById('f-salle').value.trim();
  const quantite=document.getElementById('f-quantite').value;
  const description=document.getElementById('f-description').value.trim();
  if(!date||!zone||!salle||!quantite){toast('‚ö†Ô∏è Champs obligatoires manquants');return;}
  livraisons.push({id:Date.now(),date,zone,salle,quantite:parseFloat(quantite),description});
  save();
  toast('‚úÖ Livraison enregistr√©e !');
  document.getElementById('f-zone').value='';
  document.getElementById('f-salle').value='';
  document.getElementById('f-quantite').value='';
  document.getElementById('f-description').value='';
  document.querySelector('.main-content').scrollTop=0;
}

function resetForm() {
  document.getElementById('f-date').value=todayISO;
  ['f-zone','f-salle','f-quantite','f-description'].forEach(id=>document.getElementById(id).value='');
}

function deleteLivraison(id) {
  if(!confirm('Supprimer cette livraison ?'))return;
  livraisons=livraisons.filter(l=>l.id!==id);
  save(); renderHistorique();
}

function renderCard(l, showDelete=true) {
  return `<div class="delivery-card">
    <div class="card-top">
      <div><div class="card-zone">${esc(l.zone)}</div><div class="card-date">${formatDate(l.date)}</div></div>
      <div class="card-right">
        <div class="card-qty">${l.quantite.toLocaleString('fr-FR')} L</div>
        ${showDelete?`<button class="delete-btn" onclick="deleteLivraison(${l.id})">üóë</button>`:''}
      </div>
    </div>
    <div class="card-bottom">
      <span class="card-salle">${esc(l.salle)}</span>
      ${l.description?`<span class="card-desc">${esc(l.description)}</span>`:''}
    </div>
  </div>`;
}

function renderTodayList() {
  const today=livraisons.filter(l=>l.date===todayISO).reverse();
  document.getElementById('today-list').innerHTML=today.length?today.map(l=>renderCard(l)).join(''):
    '<div class="empty"><div class="empty-icon">üì¶</div><p>Aucune livraison aujourd\'hui</p></div>';
}

function renderHistorique() {
  const df=document.getElementById('filter-date').value;
  const zf=document.getElementById('filter-zone').value.toLowerCase();
  let data=[...livraisons].sort((a,b)=>b.date.localeCompare(a.date));
  if(df) data=data.filter(l=>l.date===df);
  if(zf) data=data.filter(l=>l.zone.toLowerCase().includes(zf)||l.salle.toLowerCase().includes(zf));
  document.getElementById('hist-count').textContent=data.length?`${data.length} livraison(s)`:'';
  document.getElementById('hist-list').innerHTML=data.length?data.map(l=>renderCard(l)).join(''):
    '<div class="empty"><div class="empty-icon">üóÇÔ∏è</div><p>Aucune livraison trouv√©e</p></div>';
}

function renderBilan() {
  const m=parseInt(document.getElementById('bilan-month').value);
  const y=parseInt(document.getElementById('bilan-year').value);
  const MOIS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  const data=livraisons.filter(l=>{const d=new Date(l.date);return d.getMonth()===m&&d.getFullYear()===y;}).sort((a,b)=>a.date.localeCompare(b.date));
  const sum=document.getElementById('bilan-summary');
  const emp=document.getElementById('bilan-empty');
  if(!data.length){sum.style.display='none';emp.style.display='block';return;}
  emp.style.display='none'; sum.style.display='block';
  const totalQty=data.reduce((s,l)=>s+l.quantite,0);
  const zones=[...new Set(data.map(l=>l.zone))].length;
  document.getElementById('bilan-totaux').innerHTML=`
    <div><div class="s-label">Livraisons</div><div class="s-val">${data.length}</div></div>
    <div><div class="s-label">Total</div><div class="s-val orange">${totalQty.toLocaleString('fr-FR')}L</div></div>
    <div><div class="s-label">Zones</div><div class="s-val">${zones}</div></div>`;
  document.getElementById('bilan-list-title').textContent=`${MOIS[m]} ${y} ‚Äî D√©tail`;
  document.getElementById('bilan-list').innerHTML=data.map(l=>renderCard(l,false)).join('');
}

function clearFilters() {
  document.getElementById('filter-date').value='';
  document.getElementById('filter-zone').value='';
  renderHistorique();
}

function formatDate(d){const[y,m,dd]=d.split('-');return`${dd}/${m}/${y}`;}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

// PDF JOURNALIER
function exportDayPDF() {
  const today=livraisons.filter(l=>l.date===todayISO);
  if(!today.length){toast('‚ö†Ô∏è Aucune livraison aujourd\'hui');return;}
  const doc=new jsPDF(); const W=doc.internal.pageSize.getWidth();
  doc.setFillColor(249,115,22); doc.rect(0,0,W,36,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(255,255,255);
  doc.text('RAPPORT JOURNALIER ‚Äî LIVRAISON DE CARBURANT',W/2,14,{align:'center'});
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text('GestCarbu  ‚Ä¢  Date : '+formatDate(todayISO),W/2,26,{align:'center'});
  doc.autoTable({
    head:[['N¬∞','Zone','Salle / B√¢timent','Qt√© (L)','Description']],
    body:today.map((l,i)=>[i+1,l.zone,l.salle,l.quantite.toLocaleString('fr-FR'),l.description||'‚Äî']),
    startY:44,
    styles:{font:'helvetica',fontSize:9,cellPadding:5},
    headStyles:{fillColor:[249,115,22],textColor:255,fontStyle:'bold'},
    alternateRowStyles:{fillColor:[250,250,250]},
    columnStyles:{0:{cellWidth:10},3:{cellWidth:26,halign:'right'}},
    margin:{left:14,right:14}
  });
  const fy=doc.lastAutoTable.finalY+14;
  const total=today.reduce((s,l)=>s+l.quantite,0);
  doc.setFillColor(255,247,237); doc.roundedRect(14,fy,W-28,22,3,3,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(249,115,22);
  doc.text(`Livraisons : ${today.length}   |   Quantit√© totale : ${total.toLocaleString('fr-FR')} L`,W/2,fy+14,{align:'center'});
  doc.setFontSize(7.5); doc.setTextColor(180);
  doc.text('Document g√©n√©r√© par GestCarbu',W/2,doc.internal.pageSize.getHeight()-7,{align:'center'});
  doc.save(`Livraisons_${todayISO}.pdf`);
  toast('üìÑ PDF journalier t√©l√©charg√© !');
}

// PDF BILAN
function exportBilanPDF() {
  const m=parseInt(document.getElementById('bilan-month').value);
  const y=parseInt(document.getElementById('bilan-year').value);
  const MOIS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  const data=livraisons.filter(l=>{const d=new Date(l.date);return d.getMonth()===m&&d.getFullYear()===y;}).sort((a,b)=>a.date.localeCompare(b.date));
  if(!data.length){toast('‚ö†Ô∏è Aucune livraison ce mois');return;}
  const doc=new jsPDF(); const W=doc.internal.pageSize.getWidth(); const H=doc.internal.pageSize.getHeight();
  doc.setFillColor(20,20,20); doc.rect(0,0,W,40,'F');
  doc.setFillColor(249,115,22); doc.rect(0,37,W,3,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(255,255,255);
  doc.text('BILAN MENSUEL ‚Äî LIVRAISONS DE CARBURANT',W/2,16,{align:'center'});
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`P√©riode : ${MOIS[m]} ${y}  ‚Ä¢  GestCarbu`,W/2,29,{align:'center'});
  doc.setTextColor(100); doc.setFontSize(8.5);
  doc.text('G√©n√©r√© le : '+new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'}),14,52);
  doc.autoTable({
    head:[['N¬∞','Date','Zone','Salle','Qt√© (L)','Description']],
    body:data.map((l,i)=>[i+1,formatDate(l.date),l.zone,l.salle,l.quantite.toLocaleString('fr-FR'),l.description||'‚Äî']),
    startY:58,
    styles:{font:'helvetica',fontSize:8.5,cellPadding:4},
    headStyles:{fillColor:[20,20,20],textColor:[249,115,22],fontStyle:'bold'},
    alternateRowStyles:{fillColor:[248,248,248]},
    columnStyles:{0:{cellWidth:10},1:{cellWidth:20},4:{cellWidth:22,halign:'right'}},
    margin:{left:14,right:14},
    didDrawPage:(d)=>{doc.setFontSize(7.5);doc.setTextColor(180);doc.text(`Page ${d.pageNumber}`,W/2,H-7,{align:'center'});}
  });
  let fy=doc.lastAutoTable.finalY+12;
  const totalQty=data.reduce((s,l)=>s+l.quantite,0);
  const zones=[...new Set(data.map(l=>l.zone))];
  doc.setFillColor(255,247,237); doc.setDrawColor(249,115,22); doc.setLineWidth(0.5);
  doc.roundedRect(14,fy,W-28,28,4,4,'FD');
  doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(249,115,22);
  doc.text('R√âCAPITULATIF',20,fy+9);
  doc.setTextColor(50); doc.setFont('helvetica','normal'); doc.setFontSize(8.5);
  doc.text(`Livraisons : ${data.length}   |   Total : ${totalQty.toLocaleString('fr-FR')} L   |   Zones : ${zones.length}`,20,fy+20);
  fy+=36;
  const byZone=zones.map(z=>[z,data.filter(l=>l.zone===z).length,data.filter(l=>l.zone===z).reduce((s,l)=>s+l.quantite,0).toLocaleString('fr-FR')+' L']);
  doc.setFont('helvetica','bold'); doc.setFontSize(8.5); doc.setTextColor(80);
  doc.text('D√©tail par zone :',14,fy);
  doc.autoTable({
    head:[['Zone','Nb livraisons','Quantit√©']],
    body:byZone, startY:fy+5,
    styles:{font:'helvetica',fontSize:8,cellPadding:3.5},
    headStyles:{fillColor:[60,60,60],textColor:255,fontStyle:'bold'},
    alternateRowStyles:{fillColor:[248,248,248]},
    margin:{left:14,right:14}, tableWidth:120
  });
  fy=doc.lastAutoTable.finalY;
  let sigY=fy+28;
  if(sigY+55>H-10){doc.addPage();sigY=24;}
  doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(80);
  doc.text('VALIDATION DU DOCUMENT',14,sigY-6);
  doc.setDrawColor(200); doc.setLineWidth(0.4); doc.setFillColor(253,253,253);
  // Signature gauche
  doc.roundedRect(14,sigY,84,50,3,3,'FD');
  doc.setFontSize(8); doc.setTextColor(100);
  doc.text('SIGNATURE DU RESPONSABLE',56,sigY+9,{align:'center'});
  doc.setDrawColor(180); doc.line(20,sigY+40,92,sigY+40);
  doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.setTextColor(160);
  doc.text('Nom, pr√©nom & signature',56,sigY+47,{align:'center'});
  // Signature droite
  doc.roundedRect(112,sigY,84,50,3,3,'FD');
  doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.setTextColor(100);
  doc.text('DATE & CACHET OFFICIEL',154,sigY+9,{align:'center'});
  doc.setDrawColor(180); doc.line(118,sigY+40,190,sigY+40);
  doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.setTextColor(160);
  doc.text('Date et cachet de l\'organisation',154,sigY+47,{align:'center'});
  doc.setFontSize(7); doc.setTextColor(180);
  doc.text(`Document confidentiel ‚Äî GestCarbu ¬© ${y}`,W/2,H-5,{align:'center'});
  doc.save(`Bilan_Carburant_${MOIS[m]}_${y}.pdf`);
  toast('üìä Bilan PDF t√©l√©charg√© !');
}
</script>
</body>
</html>
